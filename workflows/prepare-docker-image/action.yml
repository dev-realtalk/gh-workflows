name: Prepare docker image
description: "Builds and pushed docker image to ghcr"

runs:
  using: 'composite'
  steps:
    - name: Checkout repo to $GITHUB_WORKSPACE
      uses: actions/checkout@v3

    - name: Show ENVs
      shell: bash
      run: env

    - name: Login to Docker Hub
      shell: bash
      run: echo "${GITHUB_TOKEN}" | docker login ghcr.io -u does_not_need_it  --password-stdin

    - name: Build
      shell: bash
      run: docker build -t ghcr.io/${GITHUB_REPOSITORY}:${GITHUB_SHA} .

    - name: Save
      shell: bash
      run: docker push ghcr.io/${GITHUB_REPOSITORY}:${GITHUB_SHA}

    - name: Notify
      shell: bash
      run: |
        MSG="${MSG}*Docker Image Prepared*\n"
        MSG="${MSG}At \`${GITHUB_REPOSITORY}\`\n"
        MSG="${MSG}by \`${GITHUB_TRIGGERING_ACTOR}\`\n"
        MSG="${MSG}with \`${GITHUB_REF_TYPE}\` \`${GITHUB_REF_NAME}\`\n"
        MSG="${MSG}and commit \`${GITHUB_SHA}\`\n"
        
        curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -H 'Content-Type: application/json' \
          -d "{\"chat_id\": \"${CHAT_ID}\", \"text\": \"${MSG}\", \"disable_notification\":false, \"parse_mode\":\"MarkdownV2\"}"


